services:
  tokenqueue-hardhat:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: tokenqueue-hardhat-node
    ports:
      - "8546:8545"
    volumes:
      # Mount contracts and scripts for hot reload
      - ./contracts:/app/contracts
      - ./scripts:/app/scripts
      - ./test:/app/test
      - ./hardhat.config.js:/app/hardhat.config.js
      - ./artifacts:/app/artifacts
      - ./cache:/app/cache
      # Mount src for auto-generated files (ABIs, config)
      - ./src:/app/src
      # Persist node modules
      - tokenqueue_hardhat_node_modules:/app/node_modules
    networks:
      - tokenqueue-hardhat-network
    environment:
      - NODE_ENV=development
    command: npx hardhat node --hostname 0.0.0.0
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8545"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # Container for running tests
  tokenqueue-hardhat-test:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: tokenqueue-hardhat-test
    volumes:
      - ./contracts:/app/contracts
      - ./scripts:/app/scripts
      - ./test:/app/test
      - ./hardhat.config.js:/app/hardhat.config.js
      - tokenqueue_hardhat_node_modules:/app/node_modules
    networks:
      - tokenqueue-hardhat-network
    profiles:
      - test
    command: npx hardhat test

volumes:
  tokenqueue_hardhat_node_modules:

networks:
  tokenqueue-hardhat-network:
    driver: bridge
