services:
  hardhat:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: hardhat-node
    ports:
      - "8545:8545"
    volumes:
      # Mount contracts and scripts for hot reload
      - ./contracts:/app/contracts
      - ./scripts:/app/scripts
      - ./test:/app/test
      - ./hardhat.config.js:/app/hardhat.config.js
      - ./artifacts:/app/artifacts
      - ./cache:/app/cache
      # Mount src for auto-generated files (ABIs, config)
      - ./src:/app/src
      # Persist node modules
      - hardhat_node_modules:/app/node_modules
    networks:
      - hardhat-network
    environment:
      - NODE_ENV=development
    command: npx hardhat node --hostname 0.0.0.0

  # Container for running tests
  hardhat-test:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: hardhat-test
    volumes:
      - ./contracts:/app/contracts
      - ./scripts:/app/scripts
      - ./test:/app/test
      - ./hardhat.config.js:/app/hardhat.config.js
      - hardhat_node_modules:/app/node_modules
    networks:
      - hardhat-network
    profiles:
      - test
    command: npx hardhat test

volumes:
  hardhat_node_modules:

networks:
  hardhat-network:
    driver: bridge
